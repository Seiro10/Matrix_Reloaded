services:
  # Router Agent
  router-agent:
    build:
      context: ./services/router-agent
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - ENVIRONMENT=production
      - PORT=8080
      - DB_PATH=/app/data/content_db.sqlite
      # API keys
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      # Agent communication URLs - use service names
      - REWRITER_AGENT_URL=http://rewriter-agent:8082
      - METADATA_GENERATOR_URL=http://metadata-generator:8084
    volumes:
      - router_agent_data:/app/data
      - router_agent_output:/app/output
      - router_agent_logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - content-agents
    depends_on:
      - copywriter-agent

  # NEW Rewriter Agent (FastAPI + LangGraph)
  rewriter-agent:
    build:
      context: ./services/rewriter-agent
      dockerfile: Dockerfile
    ports:
      - "8082:8082"
    environment:
      - ENVIRONMENT=production
      - PYTHONPATH=/app
      # API Keys
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY}
      # WordPress Configuration
      - USERNAME_WP=${WORDPRESS_USERNAME}
      - PASSWORD_WP=${WORDPRESS_PASSWORD}
      - WORDPRESS_BASE_URL=${WORDPRESS_API_URL:-https://stuffgaming.fr}
    volumes:
      - rewriter_agent_logs:/app/logs
      - rewriter_agent_temp:/app/temp
      - rewriter_agent_generated:/app/generated
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - content-agents

  # NEW Copywriter Agent
  copywriter-agent:
    build:
      context: ./services/agents-copywriter
      dockerfile: Dockerfile
    ports:
      - "8083:8083"
    environment:
      - ENVIRONMENT=production
      - PORT=8083
      # API Keys
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      # WordPress Configuration
      - USERNAME_WP=${WORDPRESS_USERNAME}
      - PASSWORD_WP=${WORDPRESS_PASSWORD}
      - WORDPRESS_BASE_URL=${WORDPRESS_API_URL:-https://stuffgaming.fr}
    volumes:
      - copywriter_agent_logs:/app/logs
      - copywriter_agent_temp:/app/temp
      - copywriter_agent_generated:/app/generated
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - content-agents

  # NEW Metadata Generator Agent
  metadata-generator:
    build:
      context: ./services/metadata-generator
      dockerfile: Dockerfile
    ports:
      - "8084:8084"
    environment:
      - ENVIRONMENT=production
      - PORT=8084
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - COPYWRITER_AGENT_URL=http://copywriter-agent:8083
    volumes:
      - metadata_generator_logs:/app/logs
      - metadata_generator_temp:/app/temp
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - content-agents
    depends_on:
      - copywriter-agent

  # Content Finder Agent
  content-finder:
    build:
      context: ./services/agents-content-finder
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - ENVIRONMENT=production
      - PORT=8000
      - ROUTER_AGENT_URL=http://router-agent:8080
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - DATAFOR_SEO_TOKEN=${DATAFOR_SEO_TOKEN}
      - BRIGHT_DATA_API_KEY=${BRIGHT_DATA_API_KEY}
      - BRIGHTDATA_ZONE_NAME=${BRIGHTDATA_ZONE_NAME}
    volumes:
      - content_finder_output:/app/output
      - content_finder_data:/app/data
      - content_finder_logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - content-agents

volumes:
  router_agent_data:
    driver: local
  router_agent_output:
    driver: local
  router_agent_logs:
    driver: local
  rewriter_agent_logs:
    driver: local
  rewriter_agent_temp:
    driver: local
  rewriter_agent_generated:
    driver: local
  copywriter_agent_logs:
    driver: local
  copywriter_agent_temp:
    driver: local
  copywriter_agent_generated:
    driver: local
  content_finder_output:
    driver: local
  content_finder_data:
    driver: local
  content_finder_logs:
    driver: local
  metadata_generator_logs:
    driver: local
  metadata_generator_temp:
    driver: local

networks:
  content-agents:
    driver: bridge